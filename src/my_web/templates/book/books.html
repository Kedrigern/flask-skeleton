{% extends 'base.html' %}
{% block content %}
<link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>

<h2>Books (Classic)</h2>
<p>Standard server-side rendering. Page reloads on every action.</p>

<table>
    <thead>
        <tr>
            <th>Title</th>
            <th>Author</th>
            <th>ISBN</th>
        </tr>
    </thead>
    <tbody>
    {% for book in books %}
        <tr>
            <td>
                <a href="{{url_for('book.detail', id=book.id)}}">{{book.title}}</a>
            </td>
            <td>
                {% for author in book.authors %}
                    {% if not loop.first %}, {% endif %}{{author.name}}
                {% endfor %}
            </td>
            <td>{{book.isbn}}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<hr style="margin: 40px 0; border-top: 2px dashed #ccc;">

<h2>Books (Interactive API)</h2>
<p>
    Dynamic rendering using <a href="https://tabulator.info">Tabulator</a>
    and <a href="{{ url_for('api_book.api_list') }}">JSON API</a>.
    Try sorting, paging, or filtering without page reload.
</p>

<div id="books-table"></div>

<script type="text/javascript">
    var authorsFormatter = function(cell, formatterParams, onRendered){
        var authors = cell.getValue();
        if(authors && authors.length > 0){
            return authors.map(a => a.name).join(", ");
        }
        return "<em style='color: #999;'>No author</em>";
    };

    var titleFormatter = function(cell, formatterParams, onRendered){
        var data = cell.getData();
        var title = cell.getValue();
        return `<a href="/book/${data.id}" style="font-weight:bold; text-decoration: none; color: #007bff;">${title}</a>`;
    };

    var table = new Tabulator("#books-table", {
        height: "400px",
        layout: "fitColumns",
        placeholder: "No Data Available",

        ajaxURL: "{{ url_for('api_book.api_list') }}",
        ajaxConfig: "GET",

        pagination: true,
        paginationMode: "remote",
        sortMode: "remote",
        filterMode: "remote",

        paginationSize: 5,
        paginationSizeSelector: [5, 10, 25],

        ajaxURLGenerator: function(url, config, params){
            var queryParts = [];

            if(params.page) queryParts.push("page=" + params.page);
            if(params.size) queryParts.push("size=" + params.size);

            if(params.sort && params.sort.length > 0){
                 queryParts.push("sort=" + encodeURIComponent(JSON.stringify(params.sort)));
            }

            if(params.filter && params.filter.length > 0){
                 queryParts.push("filter=" + encodeURIComponent(JSON.stringify(params.filter)));
            }

            return url + "?" + queryParts.join("&");
        },

        columns: [
            {title: "ID", field: "id", width: 60, sorter: "number", hozAlign: "center"},
            {
                title: "Title",
                field: "title",
                formatter: titleFormatter,
                sorter: "string",
                headerFilter: "input",
                widthGrow: 2
            },
            {
                title: "Authors",
                field: "authors",
                formatter: authorsFormatter,
                sorter: "string",
                headerSort: true,
                headerFilter: "input",
                widthGrow: 1
            },
            {title: "ISBN", field: "isbn", sorter: "string", headerFilter: "input"}
        ],

        locale: true,
        langs: {
            "default": {
                "pagination": {
                    "first": "First", "last": "Last", "prev": "Prev", "next": "Next",
                }
            }
        }
    });

    var filterInput = document.getElementById("filter-value");
    var clearBtn = document.getElementById("filter-clear");
</script>
{% endblock %}
